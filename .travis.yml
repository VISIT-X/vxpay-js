language: node_js

os:
- linux
- osx

cache:
  bundler: true

# test step is auto-configured: npm run test

stages:
  - lint
  - test
  - build
  - deploy

node_js:
- 8
- node

jobs:
  include:

  - stage: lint
    name: "ESLint"
    string: npm run lint

  - stage: build
    name: "Build, pack & confirm NPM package"
    script:
    - ./node_modules/.bin/webpack --mode production
    - npm pack
    - VXPAY_JS_VER=$(node -p "require('./package.json').version")
    - echo "$VXPAY_JS_VER"
    - cd ../
    - mkdir vxpay-js-integration
    - cd vxpay-js-integration
    - npm install "../vxpay-js/vxpay-js-$VXPAY_JS_VER.tgz"
    - ls -l node_modules/vxpay-js/build/

  - stage: deploy
    name: "Release NPM package on TAG"
    script: echo "Deploying to npm ..."
    deploy:
      skip_cleanup: true
      provider: npm
      email: "$NPM_EMAIL"
      api_key: "$API_KEY"
      on:
        tags: true
